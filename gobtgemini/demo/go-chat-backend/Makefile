# Go Chat Backend Makefile
# ç®€åŒ–å¼€å‘å’Œéƒ¨ç½²æµç¨‹

.PHONY: help build run test clean docker-build docker-run dev setup

# é»˜è®¤ç›®æ ‡
help:
	@echo "Go Chat Backend - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "  setup        - åˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒ"
	@echo "  dev          - å¼€å‘æ¨¡å¼è¿è¡Œ"
	@echo "  build        - ç¼–è¯‘åº”ç”¨"
	@echo "  run          - è¿è¡Œåº”ç”¨"
	@echo "  test         - è¿è¡Œæµ‹è¯•"
	@echo "  clean        - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  docker-build - æ„å»ºDockeré•œåƒ"
	@echo "  docker-run   - è¿è¡ŒDockerå®¹å™¨"
	@echo "  deploy       - ä½¿ç”¨Docker Composeéƒ¨ç½²"
	@echo "  logs         - æŸ¥çœ‹åº”ç”¨æ—¥å¿—"
	@echo "  stop         - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo ""

# åˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒ
setup:
	@echo "ğŸ“¦ åˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒ..."
	@if [ ! -f .env ]; then cp .env.example .env; echo "âœ… å·²åˆ›å»º .env æ–‡ä»¶"; fi
	@mkdir -p logs
	@go mod tidy
	@echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
	@echo "âš ï¸  è¯·ç¼–è¾‘ .env æ–‡ä»¶é…ç½®æ‚¨çš„å‚æ•°"

# å¼€å‘æ¨¡å¼è¿è¡Œ
dev: setup
	@echo "ğŸš€ å¼€å‘æ¨¡å¼å¯åŠ¨..."
	@go run main.go

# ç¼–è¯‘åº”ç”¨
build:
	@echo "ğŸ”¨ ç¼–è¯‘åº”ç”¨..."
	@go build -o bin/go-chat-backend .
	@echo "âœ… ç¼–è¯‘å®Œæˆ: bin/go-chat-backend"

# è¿è¡Œåº”ç”¨
run: build
	@echo "ğŸš€ è¿è¡Œåº”ç”¨..."
	@./bin/go-chat-backend

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@go test -v ./...

# æ¸…ç†ç¼–è¯‘æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	@rm -rf bin/
	@rm -rf logs/*.log
	@go clean
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ„å»ºDockeré•œåƒ
docker-build:
	@echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
	@docker build -t go-chat-backend .
	@echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"

# è¿è¡ŒDockerå®¹å™¨
docker-run: docker-build
	@echo "ğŸ³ è¿è¡ŒDockerå®¹å™¨..."
	@docker run --rm -p 8080:8080 --env-file .env go-chat-backend

# ä½¿ç”¨Docker Composeéƒ¨ç½²
deploy:
	@echo "ğŸš€ ä½¿ç”¨Docker Composeéƒ¨ç½²..."
	@chmod +x deploy.sh
	@./deploy.sh

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
logs:
	@echo "ğŸ“‹ æŸ¥çœ‹åº”ç”¨æ—¥å¿—..."
	@if [ -f docker-compose.yml ]; then \
		docker-compose logs -f app; \
	else \
		tail -f logs/app.log; \
	fi

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop:
	@echo "â¹ï¸  åœæ­¢æ‰€æœ‰æœåŠ¡..."
	@if [ -f docker-compose.yml ]; then \
		docker-compose down; \
		echo "âœ… Docker ComposeæœåŠ¡å·²åœæ­¢"; \
	else \
		echo "â„¹ï¸  æ²¡æœ‰æ‰¾åˆ°docker-compose.ymlæ–‡ä»¶"; \
	fi

# é‡å¯æœåŠ¡
restart: stop deploy

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status:
	@echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
	@if [ -f docker-compose.yml ]; then \
		docker-compose ps; \
	else \
		echo "â„¹ï¸  æ²¡æœ‰æ‰¾åˆ°docker-compose.ymlæ–‡ä»¶"; \
	fi

# æ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœéœ€è¦æ‰‹åŠ¨è¿è¡Œï¼‰
migrate:
	@echo "ğŸ—ƒï¸  è¿è¡Œæ•°æ®åº“è¿ç§»..."
	@go run scripts/migrate.go

# ç”ŸæˆAPIæ–‡æ¡£
docs:
	@echo "ğŸ“š ç”ŸæˆAPIæ–‡æ¡£..."
	@echo "â„¹ï¸  è¯·æŸ¥çœ‹ README.md ä¸­çš„APIæ–‡æ¡£éƒ¨åˆ†"

# ä»£ç æ ¼å¼åŒ–
fmt:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	@go fmt ./...
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run; \
	else \
		echo "âš ï¸  golangci-lint æœªå®‰è£…ï¼Œè·³è¿‡ä»£ç æ£€æŸ¥"; \
		echo "   å®‰è£…å‘½ä»¤: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"; \
	fi

# å®‰å…¨æ£€æŸ¥
sec:
	@echo "ğŸ”’ è¿è¡Œå®‰å…¨æ£€æŸ¥..."
	@if command -v gosec >/dev/null 2>&1; then \
		gosec ./...; \
	else \
		echo "âš ï¸  gosec æœªå®‰è£…ï¼Œè·³è¿‡å®‰å…¨æ£€æŸ¥"; \
		echo "   å®‰è£…å‘½ä»¤: go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest"; \
	fi

# æ€§èƒ½åŸºå‡†æµ‹è¯•
bench:
	@echo "âš¡ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
	@go test -bench=. ./...

# è¦†ç›–ç‡æµ‹è¯•
coverage:
	@echo "ğŸ“Š è¿è¡Œè¦†ç›–ç‡æµ‹è¯•..."
	@go test -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ: coverage.html"

# ä¾èµ–æ›´æ–°
update:
	@echo "ğŸ“¦ æ›´æ–°ä¾èµ–..."
	@go get -u ./...
	@go mod tidy
	@echo "âœ… ä¾èµ–æ›´æ–°å®Œæˆ"

# å®Œæ•´æ£€æŸ¥ï¼ˆæ ¼å¼åŒ– + æ£€æŸ¥ + æµ‹è¯•ï¼‰
check: fmt lint test
	@echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"

# ç”Ÿäº§æ„å»º
release: clean check build
	@echo "ğŸ‰ ç”Ÿäº§ç‰ˆæœ¬æ„å»ºå®Œæˆ"
